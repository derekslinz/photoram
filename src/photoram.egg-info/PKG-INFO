Metadata-Version: 2.4
Name: photoram
Version: 1.0.0
Summary: Modern CLI photo tagger powered by RAM++ (Recognize Anything Model)
Author: lderek
License-Expression: MIT
Keywords: image-tagging,photo,keywords,RAM++,deep-learning,cli
Classifier: Development Status :: 5 - Production/Stable
Classifier: Environment :: Console
Classifier: Intended Audience :: End Users/Desktop
Classifier: Programming Language :: Python :: 3
Classifier: Topic :: Multimedia :: Graphics
Requires-Python: >=3.9
Description-Content-Type: text/markdown
Requires-Dist: torch>=2.0
Requires-Dist: torchvision>=0.15
Requires-Dist: Pillow>=9.0
Requires-Dist: ram @ git+https://github.com/xinyu1205/recognize-anything.git@7cb804a8609e9f4b1a50b7f31436d2df40bb9481
Requires-Dist: huggingface-hub>=0.20
Requires-Dist: rich>=13.0
Requires-Dist: click>=8.0
Requires-Dist: transformers<4.46,>=4.30
Requires-Dist: timm
Requires-Dist: scipy
Requires-Dist: fairscale
Provides-Extra: metadata
Requires-Dist: pyexiv2>=2.8; extra == "metadata"
Provides-Extra: dev
Requires-Dist: pytest>=7.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0; extra == "dev"
Provides-Extra: all
Requires-Dist: pyexiv2>=2.8; extra == "all"

# photoram

`photoram` is a CLI photo tagger powered by RAM++ (Recognize Anything Model Plus Plus). It is designed as a modern, scriptable successor to [photils-cli](https://github.com/scheckmedia/photils-cli). The installed command is `photoram-cli`.

## Highlights

- RAM++ tagging with 4,585+ open-set labels.
- Offline inference after first-run checkpoint download.
- Batch inference (`--batch-size`) for better GPU throughput.
- Stable JSON output contract: `--format json` always returns a list.
- Standardized exit codes and validation errors.
- Service-layer architecture (`TaggingService`) that decouples CLI from model internals.
- photils compatibility flags: `--image`, `--output_file`, `--with_confidence`.

## Requirements

- Python 3.9+
- `pip`
- `git` (for source installs)

## Installation

### Local editable install

```bash
python3 -m venv .venv
source .venv/bin/activate
python -m pip install --upgrade pip
pip install -e .
photoram-cli --help
```

### Optional extras

```bash
# Metadata fallback support (pyexiv2)
pip install -e ".[metadata]"

# Test tooling
pip install -e ".[dev]"
```

If you use `--write-metadata`, installing `exiftool` is recommended:

```bash
# macOS
brew install exiftool

# Debian/Ubuntu
sudo apt install libimage-exiftool-perl
```

## Quick Start

```bash
# Tag one image
photoram-cli tag photo.jpg

# Include confidence scores
photoram-cli tag photo.jpg --confidence

# Recursive directory tagging
photoram-cli tag ./photos --recursive

# Batch inference (faster on GPU, higher VRAM use)
photoram-cli tag ./photos --recursive --batch-size 8

# Write metadata
photoram-cli tag photo.jpg --write-metadata

# JSON output (always a list)
photoram-cli tag photo.jpg --format json

# Print timing summary (model load, tagging, total)
photoram-cli tag photo.jpg -T

# Show environment/model cache info
photoram-cli info
```

Note: first run requires internet access to download the RAM++ checkpoint into the local cache.

## Commands

### `photoram-cli tag`

```text
photoram-cli tag [OPTIONS] INPUT...

Arguments:
  INPUT                  Image file(s) or directory to tag

Options:
  -t, --threshold FLOAT  Detection threshold 0.0-1.0 (default: 0.68)
  -n, --top-n INTEGER    Maximum number of tags to return
  -c, --confidence       Show confidence scores
  -f, --format FORMAT    Output format: text, json, csv (default: text)
  -o, --output FILE      Write results to file
  -r, --recursive        Recursively scan directories
      -w, --write-metadata   Write tags to image EXIF/XMP/IPTC metadata
      --overrides FILE   Tag override/translation JSON file
      --batch-size INT   Images per inference batch (default: 1)
      --chinese          Also output Chinese tags
  -T, --timings          Print basic timings (load, tagging, total)
  -q, --quiet            Suppress progress output
      --help             Show help
```

Compatibility alias for photils-dt-style calls:

```bash
photoram-cli tag --image "$FILE"
```

### `photoram-cli info`

Prints package version, torch/runtime capability, resolved default device, and model cache information.

## Output Contract

### JSON (`--format json`)

Always returns a list, even for one image.

```json
[
  {
    "file": "photo.jpg",
    "tags": ["tree", "sky"]
  }
]
```

- Add `--confidence` to include `confidences`.
- Add `--chinese` to include `tags_chinese`.
- Failed files include an `error` field.

### Text (`--format text`)

- One image: `tag1 | tag2 | tag3`
- Multiple images: `<file>\t<tags>` per line

### CSV (`--format csv`)

- Base columns: `file`, `tags`
- Optional columns: `confidences`, `tags_chinese`

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | No images found |
| 2 | Invalid arguments |
| 3 | Model/download/load error |
| 4 | Other runtime error |

## Tag Overrides

Create `override_labels.json`:

```json
{
  "blackbackground": "black background",
  "art": "kunst",
  "shadow": "schatten"
}
```

Lookup order:

- Explicit `--overrides <file>`
- `~/.config/photoram/override_labels.json`

## Architecture

```text
cli.py -> service.py -> model.py
                 \-> utils.py
                 \-> schemas.py
                 \-> errors.py
                 \-> metadata.py
```

- `src/photoram/cli.py`: Click commands, progress, output and exit handling.
- `src/photoram/service.py`: orchestration layer (collection, dispatch, post-processing).
- `src/photoram/model.py`: RAM++ loading, checkpoint management, inference.
- `src/photoram/schemas.py`: result schemas (`TagResult`, `BatchResult`).
- `src/photoram/errors.py`: exception hierarchy and exit codes.
- `src/photoram/metadata.py`: metadata writing adapters.
- `src/photoram/utils.py`: file discovery, overrides, format helpers.

## Development and Tests

```bash
pip install -e ".[dev]"
pytest
```

If running tests without editable install:

```bash
PYTHONPATH=src pytest
```

Main CLI contract tests:

- `tests/test_cli.py`
- `tests/test_cli_integration.py`

## License

MIT
